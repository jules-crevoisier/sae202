<VirtualHost *:80>

  ServerName mmi24c01.sae202.ovh
  ServerAdmin prof@mmi-troyes.fr

  DocumentRoot /var/www/sae202
  DirectoryIndex index.php

        <Directory /var/www/sae202>
                Options Indexes FollowSymlinks
                AllowOverride All
                Require all granted

        #Reecriture des URLs pour le routeur MVC
        
              RewriteEngine On
              
              # Protection des routes d'administration AVANT la réécriture générale
              RewriteCond %{REQUEST_URI} ^/gestion
              RewriteRule ^(.*)$ - [E=ADMIN_ACCESS:1]
              
              # Réécriture générale pour le routeur MVC
              RewriteCond %{REQUEST_FILENAME} !-f
              RewriteCond %{REQUEST_FILENAME} !-d
              RewriteRule ^([^/]+) index.php/$1
              
        </Directory>

        # Protection des pages d'administration via les routes /gestion/*
        <LocationMatch "^/gestion">
                AuthType Basic
                AuthBasicProvider file
                AuthName "Administration SAE202 - Murder Party"
                AuthUserFile "/home/mmi24c01/htpassword.mmi"
                <RequireAny>
                    Require ip 195.83.128.43 194.199.63.200 194.199.63.199
                    Require valid-user
                </RequireAny>
        </LocationMatch>

        # Protection alternative avec Location simple
        <Location "/gestion">
                AuthType Basic
                AuthBasicProvider file
                AuthName "Administration SAE202 - Murder Party"
                AuthUserFile "/home/mmi24c01/htpassword.mmi"
                <RequireAny>
                    Require ip 195.83.128.43 194.199.63.200 194.199.63.199
                    Require valid-user
                </RequireAny>
        </Location>

        # Protection des sous-routes d'administration
        <Location "/gestion/dashboard">
                AuthType Basic
                AuthBasicProvider file
                AuthName "Administration SAE202 - Dashboard"
                AuthUserFile "/home/mmi24c01/htpassword.mmi"
                <RequireAny>
                    Require ip 195.83.128.43 194.199.63.200 194.199.63.199
                    Require valid-user
                </RequireAny>
        </Location>

        <Location "/gestion/utilisateurs">
                AuthType Basic
                AuthBasicProvider file
                AuthName "Administration SAE202 - Utilisateurs"
                AuthUserFile "/home/mmi24c01/htpassword.mmi"
                <RequireAny>
                    Require ip 195.83.128.43 194.199.63.200 194.199.63.199
                    Require valid-user
                </RequireAny>
        </Location>

        <Location "/gestion/commentaires">
                AuthType Basic
                AuthBasicProvider file
                AuthName "Administration SAE202 - Commentaires"
                AuthUserFile "/home/mmi24c01/htpassword.mmi"
                <RequireAny>
                    Require ip 195.83.128.43 194.199.63.200 194.199.63.199
                    Require valid-user
                </RequireAny>
        </Location>

        <Location "/gestion/messages">
                AuthType Basic
                AuthBasicProvider file
                AuthName "Administration SAE202 - Messages"
                AuthUserFile "/home/mmi24c01/htpassword.mmi"
                <RequireAny>
                    Require ip 195.83.128.43 194.199.63.200 194.199.63.199
                    Require valid-user
                </RequireAny>
        </Location>

        # Protection des fichiers admin directement accessibles
        <Directory /var/www/sae202/view/admin>
                AuthType Basic
                AuthBasicProvider file
                AuthName "Administration SAE202 - Fichiers Admin"
                AuthUserFile "/home/mmi24c01/htpassword.mmi"
                <RequireAny>
                    Require ip 195.83.128.43 194.199.63.200 194.199.63.199
                    Require valid-user
                </RequireAny>
        </Directory>

</VirtualHost> 